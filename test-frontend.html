<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
        #input { width: 300px; margin-right: 10px; }
        .message { margin: 5px 0; padding: 5px; }
        .user { background: #e3f2fd; }
        .assistant { background: #f1f8e9; }
    </style>
</head>
<body>
    <h1>AI Chat Test</h1>
    <div id="messages"></div>
    <input type="text" id="input" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="testWelcome()">Test Welcome</button>

    <script>
        const messagesDiv = document.getElementById('messages');

        function addMessage(content, isUser = false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;
            div.textContent = content;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function testWelcome() {
            try {
                const response = await fetch('http://localhost:8000/api/welcome');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.done) {
                                    addMessage(content);
                                    return;
                                }
                                content += data.content;
                            } catch (e) {
                                console.warn('Parse error:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Welcome error:', error);
                addMessage('Error loading welcome message');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('input');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, true);
            input.value = '';

            try {
                const response = await fetch('http://localhost:8000/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, prompt_type: 'default' })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let content = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.done) {
                                    addMessage(content);
                                    return;
                                }
                                content += data.content;
                            } catch (e) {
                                console.warn('Parse error:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Send error:', error);
                addMessage('Error sending message');
            }
        }

        document.getElementById('input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Auto-load welcome message
        testWelcome();
    </script>
</body>
</html>
